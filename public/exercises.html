<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Exercises</title>
    <script type="module">
        import { auth } from "./firebase.js"; 
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"; 
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"; 
        import { db } from "./firebase.js"; 

        async function fetchAndDisplayExercises() {
            const user = auth.currentUser;
            if (user) {
                const userDoc = doc(db, "users", user.uid);
                const userData = await getDoc(userDoc);
                if (userData.exists()) {
                    const { disabilityType, disabilityName, levelOfDisability, age, gender } = userData.data();
                    try {
                        const exercises = await fetchExercisesFromServer(disabilityType, disabilityName, levelOfDisability, age, gender);
                        displayExercises(exercises);
                    } catch (error) {
                        console.error("Error fetching exercises from server:", error);
                        alert("Error fetching exercises.");
                    }
                } else {
                    alert("No user data found!");
                }
            } else {
                alert("User not logged in.");
                window.location.href = 'login.html';
            }
        }

        async function fetchExercisesFromServer(disabilityType, disabilityName, levelOfDisability, age, gender) {
            try {
                const response = await fetch('http://localhost:4000/get-exercises', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ disabilityType, disabilityName, levelOfDisability, age, gender }),
                });

                console.log('Response status:', response.status); // Log response status
                
                if (!response.ok) {
                    const errorText = await response.text(); // Get the error message
                    console.error("Error details:", errorText); // Log error details
                    throw new Error("Failed to fetch exercises from server.");
                }

                const data = await response.json();
                return data.exercises; // assuming server responds with { exercises: ... }
            } catch (error) {
                console.error("Error in fetchExercisesFromServer:", error);
                throw error;
            }
        }

        function displayExercises(exercises) {
            document.getElementById('exercises').innerText = exercises || "No exercises available.";
            // const exercisesContainer = document.getElementById('exercises');
            // exercisesContainer.innerHTML = ""; // Clear previous content
            
            // // Create a list to display exercises
            // const ul = document.createElement('ul');
            // exercises.split(',').forEach(exercise => {
            //     const li = document.createElement('li');
            //     li.innerText = exercise.trim(); // Trim spaces and set text
            //     ul.appendChild(li);
            // });

            // exercisesContainer.appendChild(ul);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                fetchAndDisplayExercises();
            } else {
                window.location.href = 'login.html';
            }
        });
    </script>
</head>
<body>
    <h1>Your Exercises</h1>
    <div id="exercises"></div>
</body>
</html>
